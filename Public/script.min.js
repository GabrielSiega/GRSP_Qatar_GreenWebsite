const form=document.getElementById("bookingForm"),bookingsTableBody=document.querySelector("#bookingsTable tbody"),availableFlightsTableBody=document.querySelector("#availableFlightsTable tbody"),originDropdown=document.getElementById("origin"),destinationDropdown=document.getElementById("destination");async function loadAvailableFlights(){try{const o=await fetch("/api/flights"),t=await o.json(),n=[...new Set(t.map(o=>o.origin))],e=[...new Set(t.map(o=>o.destination))];originDropdown.innerHTML='<option value="">-- Select origin --</option>',n.forEach(o=>{const t=document.createElement("option");t.value=o,t.textContent=o,originDropdown.appendChild(t)}),destinationDropdown.innerHTML='<option value="">-- Select destination --</option>',e.forEach(o=>{const t=document.createElement("option");t.value=o,t.textContent=o,destinationDropdown.appendChild(t)}),availableFlightsTableBody.innerHTML="",t.forEach(o=>{const t=document.createElement("tr");t.innerHTML=`\n        <td>${o.flightNumber}</td>\n        <td>${o.origin}</td>\n        <td>${o.destination}</td>\n        <td>${o.departureDate}</td>\n        <td>${o.arrivalDate}</td>\n      `,availableFlightsTableBody.appendChild(t)})}catch(o){console.error("Error loading available flights:",o)}}async function loadBookings(o=null){try{const t=await fetch("/api/bookings"),n=await t.json();bookingsTableBody.innerHTML="",n.forEach(t=>{const n=document.createElement("tr");n.innerHTML=`\n        <td>${t.id}</td>\n        <td>${t.passengerName||"-"}</td>\n        <td>${t.origin||"-"}</td>\n        <td>${t.destination||"-"}</td>\n        <td>${t.departureDate||"-"}</td>\n        <td>${t.arrivalDate||"-"}</td>\n        <td>${t.class||"-"}</td>\n        <td>${t.status||"Confirmed"}</td>\n      `,o&&t.id===o&&(n.style.backgroundColor="#d4edda",setTimeout(()=>{n.style.backgroundColor=""},2e3)),bookingsTableBody.appendChild(n)})}catch(o){console.error("Error loading bookings:",o)}}async function checkExistingBooking(o,t){try{const n=await fetch("/api/bookings");return(await n.json()).some(n=>n.origin.toLowerCase()===o.toLowerCase()&&n.destination.toLowerCase()===t.toLowerCase())}catch(o){return console.error("Error checking existing bookings:",o),!1}}async function loadBookings(o=null){try{const t=await fetch("/api/bookings"),n=await t.json();bookingsTableBody.innerHTML="",n.forEach(t=>{const n=document.createElement("tr");n.innerHTML=`\n        <td>${t.id}</td>\n        <td>${t.passengerName}</td>\n        <td>${t.origin}</td>\n        <td>${t.destination}</td>\n        <td>${t.status}</td>\n      `,o&&t.id===o&&(n.style.backgroundColor="#d4edda",setTimeout(()=>{n.style.backgroundColor=""},2e3)),bookingsTableBody.appendChild(n)})}catch(o){console.error("Error loading bookings:",o)}}form.addEventListener("submit",async o=>{o.preventDefault();const t=new FormData(form),n=Object.fromEntries(t.entries());if(await checkExistingBooking(n.origin,n.destination))alert(`A booking from ${n.origin} to ${n.destination} already exists!`);else try{const o=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await o.json();alert(`Flight booked for ${t.booking.passengerName}`),loadBookings(t.booking.id)}catch(o){console.error("Error booking flight:",o),alert("Failed to book flight. Please try again.")}}),document.addEventListener("DOMContentLoaded",()=>{loadAvailableFlights(),loadBookings()});